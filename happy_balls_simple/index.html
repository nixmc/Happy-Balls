<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
    #serial-container {
        position: relative;
        height: 0;
        width: 0;
        left: -99999px;
    }
    #content {
        width: 1024px;
        margin: auto;
    }
    .bucket-container {
        margin: 0;
        padding: 0;
        width: 500px;
        display: inline;
        float: left;
    }
    canvas {
        border-bottom: 1px solid;
        border-left: 1px solid;
        border-right: 1px solid;
    }
    button {
        display: block;
        width: 300px;
        height: 60px;
        margin: auto;
        font-size: 20px;
    }
    </style>
    <script type="text/javascript" src="lib/jquery/1.5.2/jquery.min.js"></script>
    <script type="text/javascript" src="lib/processing-1.2.3.min.js"></script>
    <script type="text/javascript" src="js/db.js"></script>
    <script type="text/javascript">
    var initSketch = function(sketchId) {
        if (!window[sketchId]) {
            window[sketchId] = Processing.getInstanceById(sketchId);
        }
        return window[sketchId];
    };
    
    var dropBallIntoBucket = function(bucketId) {
        var bucket = initSketch(bucketId);
        console.log("Dropping ball into:", bucketId);
        bucket.initParticle();
    };
    
    var serialityCallback = function(data) {
        var re = /Location: (\d+) happy: (\d+) sad: (\d+)/;
        console.log("Received:", data);
        var match = re.exec(data);
        if (match) {
            var location = parseInt(match[1]),
                happiness = parseInt(match[2]),
                unhappiness = parseInt(match[3]);
            getHappinessScore(location, {
                onSuccess: function(ev) {
                    var result = ev.target.result;
                    console.log(result);
                    if (!result || result.happiness < happiness || result.unhappiness < unhappiness) {
                        // Something's changed
                        var happinessIncrease = happiness - (result && result.happiness || 0),
                            unhappinessIncrease = unhappiness - (result && result.unhappiness || 0);
                        console.log("happinessIncrease:", happinessIncrease);
                        console.log("unhappinessIncrease:", unhappinessIncrease);
                        
                        // Record change...
                        putHappinessScore({
                            location: location,
                            happiness: happiness,
                            unhappiness: unhappiness,
                        }, {
                            onSuccess: function(ev) {
                                console.log("Scores updated for location:", location);
                            },
                            onError: console.log
                        });
                        
                        // Send change to server...
                        // $ curl -i -d "location=1&happiness=42&unhappiness=0" http://happy-balls.local/server/happiness/
                        $.post("http://" + document.location.hostname + "/server/happiness/", {
                            location: location, 
                            happiness: happiness, 
                            unhappiness: unhappiness
                        });
                        
                        // Drop appropriate number of balls into buckets...
                        while (happinessIncrease > 0) {
                            dropBallIntoBucket("happyBucket");
                            happinessIncrease--;
                        }
                        while (unhappinessIncrease > 0) {
                            dropBallIntoBucket("unhappyBucket");
                            unhappinessIncrease--;
                        }
                    }
                },
                onError: console.log
            });
        }
    };
    </script>
  </head>
  <body>
    <div id="serial-container">
        <object type="application/seriality" id="seriality" width="0" height="0"></object>
        <canvas id="serial" data-processing-sources="Seriality.pjs"></canvas>
    </div>
    <div id="content">
        <div class="bucket-container">
            <button onclick="dropBallIntoBucket('happyBucket');">Put a ball in the happy bucket! :D</button>
            <canvas id="happyBucket" data-processing-sources="happy_balls_simple.js Floor.pde SinkListener.pde SinkListenerImpl.pde LimitedParticle.pde Particle.pde"></canvas>
        </div>
        <div class="bucket-container">
            <button onclick="dropBallIntoBucket('unhappyBucket');">Put a ball in the unhappy bucket! :(</button>
            <canvas id="unhappyBucket" data-processing-sources="happy_balls_simple.js Floor.pde SinkListener.pde SinkListenerImpl.pde LimitedParticle.pde Particle.pde"></canvas>
        </div>
    </div>
  </body>
</html>